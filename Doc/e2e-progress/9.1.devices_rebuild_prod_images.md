=== Rebuild image cho dự án 
- **Dockerfile đa tầng (build → run)**: biên dịch Go binary tĩnh (CGO_ENABLED=0), chạy trên **distroless non-root** (an toàn, nhẹ).
  
- **Không bake secrets**: image **không** chứa `.env`; cấu hình được **inject lúc chạy** bằng `env_file` (compose).
  
- **Image prod đã build & chạy**: `wh-ma-api:prod` ~71 MB; container `api` lên OK (port `8080:8080`).
  
- **Readiness/Health**: có `/healthz` (process) và `/readiness` (DB). Đã smoke-test được.
  
- **Kết nối DB qua network compose**: `DATABASE_URL` dùng host **`db`** (không localhost) đúng chuẩn chạy trong container.
  
- **User non-root**: container chạy bằng user không phải root (distroless `:nonroot`).
  
- **Observability sẵn móc**: biến **OTEL_EXPORTER_OTLP_ENDPOINT** trỏ `otel-collector:4318` để gửi telemetry (collector đã chạy trong compose).
  
- **Logs chuẩn**: ghi stdout/stderr, phù hợp 12-Factor.
 === 1. Rebuild dockerfile
 ```yaml
 # =========================================
# Stage 1: Builder (compile Go binary)
# =========================================
FROM golang:1.25-bookworm AS builder

# Workdir cho source
WORKDIR /src

# Tối ưu cache: copy mod trước, download deps
COPY go.mod go.sum ./
RUN go mod download

# Copy phần còn lại
COPY . .

# Tắt CGO để binary tĩnh, giảm phụ thuộc
ENV CGO_ENABLED=0 GOOS=linux GOARCH=amd64

# (Optional) nhúng version/commit vào binary khi cần
ARG GIT_SHA=unknown
ARG BUILD_TIME=unknown
# Lưu ý: sửa main.package nếu biến version nằm chỗ khác
RUN go build -trimpath -ldflags "-s -w -X main.commit=$GIT_SHA -X main.buildTime=$BUILD_TIME" \
  -o /out/server ./cmd/server

# =========================================
# Stage 2: Runner (distroless, non-root)
# =========================================
# Dùng distroless base có sẵn CA certs & tzdata → an toàn cho TLS/OTEL
FROM gcr.io/distroless/base-debian12:nonroot AS runner

# Cổng mặc định app (theo .env)
EXPOSE 8080

# Thư mục app chỉ đọc; distroless nonroot user = 65532
WORKDIR /app

# Copy binary từ builder
COPY --from=builder /out/server /app/server

# (Tùy chọn) set một số env "mặc định" ở runtime
# ENV APP_ENV=docker PORT=8080

# Chạy với user nonroot (distroless đã mặc định nonroot, set lại cho rõ ràng)
USER nonroot:nonroot

# Entrypoint
ENTRYPOINT ["/app/server"]
```
=== 2. tạo .dockerignore
```
# Go
bin/
*.exe
*.out
coverage/
dist/

# VS Code
.vscode/

# Env
.env
.env.*
configs/.env

# Docker data (nếu có)
**/pgdata/

```
=== 3. rebuild prod image
```shell
# Build image API (đã làm ở bước 9)
docker build -f build/Dockerfile -t wh-ma-api:latest .

# Lên DB + API (đảm bảo api đọc ./configs/.env, trong đó có OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318)
docker compose up -d db api

# Lên observability stack
docker compose up -d otel-collector prometheus grafana

# Xem log để chắc Collector nhận trace
docker compose logs -f otel-collector

# Mở Prometheus: http://localhost:9090  (query thử: go_goroutines)
# Mở Grafana:    http://localhost:3000  (user/pass: admin / admin)
#   -> Dashboards -> "WH-MA API (Basic Go/Process Metrics)"
```
