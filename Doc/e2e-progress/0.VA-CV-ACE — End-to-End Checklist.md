# VA-CV-ACE — End-to-End Checklist

## 1) Repo & Layout

- Init repo: `go mod init github.com/ace/va-cv-ace`

- Tree prefix:
  
  `va-cv-ace/ 
  
  ├─ bin 
  
  ├─ build 
  
  ├─ cmd/server 
  
  ├─ configs 
  
  ├─ db/{migrations,queries} 
  
  ├─ doc/pm_request_api 
  
  ├─ internal 
  
  │  ├─ adapter/inbound/http/{health,request,router,service} 
  
  │  ├─ adapter/outbound/{port,repository} 
  
  │  ├─ bootstrap 
  
  │  ├─ domain 
  
  │  └─ usecase 
  
  ├─ scripts 
  
  └─ test (optional)`

## 2) Env (Twelve-Factor)

- `configs/.env.example`
  
  `APP_ENV=local PORT=8080 DATABASE_URL=postgres://postgres:postgres@db:5432/va_cv_ace?sslmode=disable PLANNER_MODE=go     # go | python | hybrid`

- Load env in `cmd/server/main.go`.

## 3) Domain (core)

- Entities:
  
  - `Device` (root): `SerialNumber`, `Name`, `Profile`(model, manufacturer, year, commission_date),  
    `State`(location, total_hours, after_overhaul, last_reading_at),  
    `Counters`(map[interval]Counter{count,last_at}), `Status` (active/maintenance/repair/mid_repair/decommissioned),  
    `PlanID`, `CreatedAt/UpdatedAt/DeletedAt` (meta hoặc `AuditMeta`).
  
  - `Reading`: lịch sử giờ & vị trí (`device_id`, `at`, `hours_delta`, `location`).
  
  - `MaintenanceEvent`: nhật ký bảo dưỡng (`device_id`, `at`, `interval`, `notes`).
  
  - `Plan`: policy bảo dưỡng (`service_intervals`, `overhaul_intervals`).

- Ports:
  
  - `PlannerPort{ RecomputeAlerts(deviceID int64) error }` (điểm tách Go → Python sau này).

## 4) DB Schema (Postgres 16)

- Tables (snapshot + history):
  
  - `devices` (snapshot nhanh + meta).
  
  - `readings` (history).
  
  - `maintenance_events` (history).
  
  - `plans` (policy intervals).
  
  - `alerts` (kết quả tính due/overdue; unique key: device+interval+window/kind).
  
  - (Option) `maintenance_counters` bảng chuẩn hoá **hoặc** JSONB trong `devices`.

- Migrations (golang-migrate):
  
  - `001_init_devices.up/down.sql`
  
  - `002_readings.up/down.sql`
  
  - `003_maintenance_events.up/down.sql`
  
  - `004_plans.up/down.sql`
  
  - `005_alerts.up/down.sql`
  
  - (Option) `006_maintenance_counters.up/down.sql`

## 5) Data Access (sqlc + pgx)

- `db/queries/`:
  
  - `devices.sql`: CRUD (create/get/update/delete soft), list, by serial.
  
  - `readings.sql`: insert reading; last reading by device.
  
  - `maintenance_events.sql`: insert event.
  
  - `alerts.sql`: upsert alert (unique composite).
  
  - `plans.sql`: CRUD plans, get by id.

- Generate: `sqlc.yaml` + `sqlc generate`.

## 6) Use-cases

- `AddReading(deviceID, hoursDelta, location)`  
  → write `readings` → update `devices` snapshot (total/after_overhaul/location/last_reading_at) → `planner.RecomputeAlerts(deviceID)`.

- `ComputeAlert(deviceID)`  
  → lấy `Device + Plan` → so `TotalHours`/`AfterOverhaul` với intervals → upsert `alerts` (due/soon/overdue).

- `MarkServiced(deviceID, interval, notes)`  
  → insert `maintenance_events` → tăng counter (interval) → nếu là overhaul thì reset `after_overhaul` → close related alerts.

## 7) HTTP API (Gin)

- Health:
  
  - `GET /healthz` → `{ "ok": true }`
  
  - `GET /readiness` → check DB.

- Devices:
  
  - `POST /devices` (create)
  
  - `GET /devices/:id`
  
  - `GET /devices` (list, filters)
  
  - `PUT /devices/:id` (update)
  
  - `DELETE /devices/:id` (soft delete)

- Readings:
  
  - `POST /devices/:id/readings` (add)
  
  - `GET /devices/:id/readings/last`

- Alerts:
  
  - `POST /devices/:id/alerts/compute` (trigger compute)
  
  - `GET /devices/:id/alerts` (list)
  
  - `POST /alerts/:id/resolve` (mark serviced/ack)

- Plans:
  
  - `POST /plans`
  
  - `GET /plans/:id`
  
  - `GET /plans`
  
  - `PUT /plans/:id`

## 8) Observability & Middlewares

- Gin recovery, logger (structured), CORS (dev).

- Request ID, basic metrics (later).

- Error model chuẩn (JSON).

## 9) Planner Mode (chuẩn bị cho Python sau này)

- Env: `PLANNER_MODE=go|python|hybrid`

- Adapter:
  
  - `GoPlanner` (in-process): tính alert trong Go.
  
  - `PythonPlanner` (HTTP client, future): call `/internal/plan/recompute`.

- (Optional) Event payload chuẩn `reading.created` (định nghĩa từ sớm).

## 10) Docker & Compose

- `build/Dockerfile` (Go multi-stage, non-root, distroless/alpine).

- `docker-compose.yml`:
  
  - `api` (build từ `build/Dockerfile`, env from `.env`).
  
  - `db` (postgres:16, volume, healthcheck).
  
  - (optional) `adminer` hoặc `pgadmin`.
  
  - (future) `planner` (python) + `broker` (redis/rabbitmq).

- On start: run migrations (entrypoint or `scripts/migrate.ps1`).

## 11) CI (minimal)

- `go vet ./...`

- `go test ./...`

- `sqlc generate`

- `migrate dry-run` (validate migrations)

- (Optional) build Docker image.

## 12) Seed (tối thiểu)

- 1 `plan` với intervals `[250,500,1000,2000,4000,5000,8000]`.

- 1 `device` gắn `plan_id`.

- (Optional) vài `readings` mẫu để có `total_hours`.

## 13) Smoke Test (PowerShell)

- Start: `docker compose up --build`

- Health:
  
  - `curl http://localhost:8080/healthz`
  
  - `curl http://localhost:8080/readiness`

- CRUD device → add reading → compute alerts → list alerts → mark serviced.

## 14) Handover

- Tài liệu nhanh: base URL, endpoints, body mẫu.

- Postman collection (đã có `/doc/pm_request_api`), cập nhật.

## 15) Lối mở sang Python (sau)

- Giữ `PlannerPort` → thêm adapter `PythonPlanner`.

- Thêm service `planner` (FastAPI/Celery) + broker (nếu cần).

- Chạy `hybrid` để so sánh kết quả → cutover `PLANNER_MODE=python`.
