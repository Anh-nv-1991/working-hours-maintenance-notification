1.    Cài migrate-cli nếu cần
go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

2.    Tạo docker-compose.yaml

```yaml
services:
  db:
    image: postgres:16
    container_name: wh-ma-db
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: Vietanh4791
      POSTGRES_DB: main-1
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL","pg_isready -U admin -d main-1"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - dbdata:/var/lib/postgresql/data

  # sqlc codegen (one-off khi cần)
  sqlc:
    image: golang:1.22
    working_dir: /app
    volumes:
      - ./:/app
    entrypoint: ["/bin/sh","-lc"]
    command: >
      go install github.com/sqlc-dev/sqlc/cmd/sqlc@v1.27.0 &&
      /go/bin/sqlc generate

  # chạy migrate kiểu one-off: docker compose run --rm migrate -path /migrations -database "$DATABASE_URL" up
  migrate:
    image: migrate/migrate:latest
    container_name: wh-ma-migrate
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://admin:Vietanh4791@db:5432/main-1?sslmode=disable
    volumes:
      - ./db/migrations:/migrations

  api:
    build:
      context: .
      dockerfile: ./build/Dockerfile   # << trỏ rõ file, tránh lỗi "open Dockerfile"
    env_file:
      - ./configs/.env
    environment:
      # override cho container: trỏ tới 'db' (không dùng localhost)
      DATABASE_URL: postgres://admin:Vietanh4791@db:5432/main-1?sslmode=disable
      PORT: "8080"
      APP_ENV: "docker"
      LOG_LEVEL: "debug"
    ports:
      - "8080:8080"
    depends_on:
      db:
        condition: service_healthy

volumes:
  dbdata: {}

```

3.    Các thao tác với docker:

```shell
#tạo file migration
docker compose run --rm migrate create -ext sql -dir /migrations -seq create_devices
docker compose run --rm migrate create -ext sql -dir /migrations -seq create_plans_and_fk_devices
docker compose run --rm migrate create -ext sql -dir /migrations -seq create_readings
docker compose run --rm migrate create -ext sql -dir /migrations -seq create_alerts
docker compose run --rm migrate create -ext sql -dir /migrations -seq create_maintenance_events

#Chạy lên tất cả migration .up
docker compose run --rm migrate `
  -path=/migrations `
  -database "postgres://admin:Vietanh4791@db:5432/main-1?sslmode=disable" `
  up

#Rollback 1 bước
docker compose run --rm migrate `
  -path=/migrations `
  -database "postgres://admin:Vietanh4791@db:5432/main-1?sslmode=disable" `
  down 1

#Xem version hiện tại
docker compose run --rm migrate `
  -path=/migrations `
  -database "postgres://admin:Vietanh4791@db:5432/main-1?sslmode=disable" `
  version
```

4.    Làm sạch db postgres cũ

```shell
# Rollback 1 step (down 1)
docker compose run --rm migrate `
  -path=/migrations `
  -database "postgres://admin:Vietanh4791@db:5432/main-1?sslmode=disable" `
  down 1

# Xem version hiện tại
docker compose run --rm migrate `
  -path=/migrations `
  -database "postgres://admin:Vietanh4791@db:5432/main-1?sslmode=disable" `
  version

# Ép về version 0 (hoặc số bạn muốn)
docker compose run --rm migrate `
  -path=/migrations `
  -database "postgres://admin:Vietanh4791@db:5432/main-1?sslmode=disable" `
  force 0
# sau đó chạy down hoặc up lại như bình thường

#Cách 2: xoá schema
# vào psql trong container db
docker exec -it wh-ma-db psql -U admin -d main-1

-- Trong psql, chạy (ví dụ):
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;  -- tạo lại schema trống

-- (tuỳ) Nếu chỉ muốn xóa vài bảng:
-- DROP TABLE IF EXISTS devices, readings, maintenance_policies, alerts CASCADE;

-- Xóa bảng tracking migration (tên mặc định):
DROP TABLE IF EXISTS schema_migrations;
\q

#Cách 3 — Xóa cả database giữ lại container
docker exec -it wh-ma-db psql -U admin -d postgres

-- Trong psql:
SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'main-1';
DROP DATABASE "main-1";
CREATE DATABASE "main-1";
\q

# Cách 4 xoá cả container
docker compose down -v

# khởi động lại DB trống
docker compose up -d db

#Xem trạng thái & log
docker compose ps
docker compose logs -f db

#Restart/Stop/Start DB
docker compose restart db
docker compose stop db
docker compose start db

# Thao tác dong docker
#1) Mở shell psql trong container
docker compose exec db psql -U admin -d main-1

#2) Lệnh kiểm tra trong psql
#Xem danh sách bảng
\dt

#Xem chi tiết bảng
\d devices
\d plans
\d readings
\d alerts
\d maintenance_events
#Xem dữ liệu bảng (sample 10 dòng)

SELECT * FROM devices LIMIT 10;
SELECT * FROM plans LIMIT 10;

#Xem toàn bộ migration đã apply
SELECT * FROM schema_migrations ORDER BY version;

#Thoát khỏi psql
\q
```